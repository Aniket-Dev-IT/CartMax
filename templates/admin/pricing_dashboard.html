{% extends "admin/professional_base.html" %}

{% block title %}Pricing Analytics Dashboard{% endblock %}

{% block page_title %}Pricing Analytics{% endblock %}

{% block content %}
<!-- Currency Selection and Dual Currency Stats -->
<div class="row mb-4">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-coins text-primary me-2"></i>
                    Currency Analytics Dashboard
                </h3>
            </div>
            <div class="row align-items-center">
                <div class="col-lg-6 mb-3">
                    <div class="d-flex flex-wrap gap-2">
                        <a href="?currency=INR" class="btn {% if selected_currency == 'INR' %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                            <i class="fas fa-rupee-sign me-1"></i> INR Analytics
                        </a>
                        <a href="?currency=USD" class="btn {% if selected_currency == 'USD' %}btn-success{% else %}btn-outline-success{% endif %} btn-sm">
                            <i class="fas fa-dollar-sign me-1"></i> USD Analytics
                        </a>
                    </div>
                </div>
                <div class="col-lg-6 mb-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="stat-value text-info" style="font-size: 20px;">{{ dual_currency_stats.inr_products }}</div>
                            <div class="stat-label">INR Products</div>
                        </div>
                        <div class="col-4">
                            <div class="stat-value text-success" style="font-size: 20px;">{{ dual_currency_stats.usd_products }}</div>
                            <div class="stat-label">USD Products</div>
                        </div>
                        <div class="col-4">
                            <div class="stat-value text-warning" style="font-size: 20px;">{{ dual_currency_stats.both_currencies }}</div>
                            <div class="stat-label">Both Currencies</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics Row -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="dashboard-card stat-card">
            <div class="card-icon bg-primary-gradient">
                <i class="fas fa-box"></i>
            </div>
            <div class="stat-value">{{ total_products }}</div>
            <div class="stat-label">Products ({{ currency_name }})</div>
            <small class="text-muted d-block mt-1">Active with pricing</small>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="dashboard-card stat-card">
            <div class="card-icon bg-success-gradient">
                <i class="fas fa-{% if selected_currency == 'USD' %}dollar-sign{% else %}rupee-sign{% endif %}"></i>
            </div>
            <div class="stat-value">{{ currency_symbol }}{{ avg_price }}</div>
            <div class="stat-label">Average Price</div>
            <small class="text-muted d-block mt-1">{{ currency_name }} products</small>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="dashboard-card stat-card" style="font-size: 11px;">
            <div class="card-icon bg-warning-gradient">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div class="stat-value" style="font-size: 18px;">{{ currency_symbol }}{{ price_range.min_price|default:"0"|floatformat:2 }} - {{ currency_symbol }}{{ price_range.max_price|default:"0"|floatformat:2 }}</div>
            <div class="stat-label">Price Range</div>
            <small class="text-muted d-block mt-1">Min to max</small>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="dashboard-card stat-card">
            <div class="card-icon bg-danger-gradient">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-value">{{ discounted_products }}</div>
            <div class="stat-label">Discounted Items</div>
            <small class="text-muted d-block mt-1">With {{ currency_name }} discounts</small>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-lg-8 mb-3">
        <div class="dashboard-card h-100">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-pie text-primary me-2"></i>
                    {{ currency_name }} Price Distribution
                </h3>
            </div>
            <div style="padding: 20px; height: 300px;">
                <canvas id="priceDistributionChart" style="max-height: 280px;"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-3">
        <div class="dashboard-card h-100">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-money-bill-wave text-success me-2"></i>
                    Revenue Summary
                </h3>
                <small class="text-muted">Last 30 days</small>
            </div>
            <div class="text-center" style="padding: 20px;">
                <div class="mb-3">
                    <div class="stat-value text-success" style="font-size: 20px;">{{ currency_symbol }}{{ total_revenue|floatformat:2 }}</div>
                    <div class="stat-label">Total Revenue</div>
                    <small class="text-muted d-block">{{ currency_name }} (Last 30 days)</small>
                </div>
                <div class="mb-3">
                    <div class="stat-value text-primary" style="font-size: 18px;">{{ currency_symbol }}{{ avg_order_value|floatformat:2 }}</div>
                    <div class="stat-label">Avg Order Value</div>
                    <small class="text-muted d-block">{{ currency_name }}</small>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 75%"></div>
                </div>
                <small class="text-muted d-block mt-2">75% of target</small>
            </div>
        </div>
    </div>
</div>

<!-- Category Analysis -->
<div class="row mb-4">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-layer-group text-warning me-2"></i>
                    {{ currency_name }} Category Analysis
                </h3>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-modern">
                    <thead class="table-primary">
                        <tr>
                            <th style="width: 35%;">Category</th>
                            <th class="text-center" style="width: 15%;">Products</th>
                            <th class="text-center" style="width: 20%;">Avg Price</th>
                            <th class="text-center" style="width: 20%;">Price Range</th>
                            <th class="text-center" style="width: 10%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for category in category_analysis %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary rounded-circle me-2 text-white d-flex align-items-center justify-content-center" style="width: 28px; height: 28px; font-size: 11px; font-weight: 600;">
                                        {{ category.name|first }}
                                    </div>
                                    <span class="fw-semibold">{{ category.name }}</span>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-info px-2 py-1">{{ category.product_count }}</span>
                            </td>
                            <td class="text-center">
                                <span class="fw-bold text-primary">{{ currency_symbol }}{{ category.avg_price|floatformat:0 }}</span>
                            </td>
                            <td class="text-center text-muted small">
                                {{ currency_symbol }}{{ category.min_price|floatformat:0 }} - {{ currency_symbol }}{{ category.max_price|floatformat:0 }}
                            </td>
                            <td class="text-center">
                                <button class="btn btn-outline-primary btn-sm" onclick="analyzeCategoryPricing({{ category.id }})">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                <i class="fas fa-info-circle me-2"></i>
                                No categories with {{ currency_name }} pricing found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Top Revenue Products -->
<div class="row mb-4">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-crown text-success me-2"></i>
                    Top {{ currency_name }} Revenue Products
                </h3>
                <small class="text-muted">Last 30 days</small>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-modern">
                    <thead class="table-success">
                        <tr>
                            <th style="width: 45%;">Product</th>
                            <th class="text-center" style="width: 20%;">Category</th>
                            <th class="text-center" style="width: 15%;">{{ currency_name }} Price</th>
                            <th class="text-center" style="width: 20%;">Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in top_revenue_products %}
                        <tr>
                            <td>
                                <div class="product-name">{{ product.name|truncatechars:45 }}</div>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-secondary small">{{ product.category.name|truncatechars:15 }}</span>
                            </td>
                            <td class="text-center">
                                {% if product.current_price %}
                                    <span class="fw-bold text-primary">{{ currency_symbol }}{{ product.current_price }}</span>
                                {% else %}
                                    <span class="text-muted small">N/A</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <span class="fw-bold text-success">{{ currency_symbol }}{{ product.revenue|floatformat:0 }}</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">
                                <i class="fas fa-info-circle me-2"></i>
                                No {{ currency_name }} revenue data available for the last 30 days
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- AI Pricing Recommendations -->
<div class="row mb-4">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-robot text-info me-2"></i>
                    {{ currency_name }} Pricing Recommendations
                </h3>
            </div>
            {% if pricing_recommendations %}
                <div style="padding: 20px;">
                    {% for rec in pricing_recommendations %}
                    <div class="alert alert-{% if rec.priority == 'high' %}danger{% elif rec.priority == 'medium' %}warning{% else %}info{% endif %} border-start border-4 mb-3" style="padding: 16px;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="alert-heading mb-2 fw-bold">{{ rec.product_name|truncatechars:50 }}</h6>
                                <p class="mb-3 small">{{ rec.reason }}</p>
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <small class="text-muted d-block">Current</small>
                                        <strong>{{ currency_symbol }}{{ rec.current_price }}</strong>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <small class="text-muted d-block">Suggested</small>
                                        <strong class="text-{% if rec.type == 'price_increase' %}success{% elif rec.type == 'price_decrease' %}danger{% else %}warning{% endif %}">{{ currency_symbol }}{{ rec.suggested_price|floatformat:2 }}</strong>
                                    </div>
                                    {% if rec.potential_revenue_increase %}
                                    <div class="col-md-3 mb-2">
                                        <small class="text-muted d-block">Potential +</small>
                                        <strong class="text-success">+{{ currency_symbol }}{{ rec.potential_revenue_increase|floatformat:0 }}</strong>
                                    </div>
                                    {% endif %}
                                    <div class="col-md-3 mb-2">
                                        <span class="badge bg-{% if rec.priority == 'high' %}danger{% elif rec.priority == 'medium' %}warning{% else %}info{% endif %} text-uppercase small">
                                            {{ rec.priority }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center" style="padding: 40px;">
                    <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                    <h6 class="mb-2">{{ currency_name }} Pricing Optimized</h6>
                    <p class="text-muted small mb-0">No specific {{ currency_name }} pricing recommendations at this time.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tools text-primary me-2"></i>
                    Quick Actions
                </h3>
            </div>
            <div class="text-center" style="padding: 20px;">
                <div class="d-flex flex-wrap justify-content-center gap-2">
                    <a href="{% url 'admin_dashboard:product_list' %}" class="btn-professional">
                        <i class="fas fa-cog me-1"></i> Manage Products
                    </a>
                    <a href="{% url 'admin_dashboard:export_pricing_data' %}?currency={{ selected_currency }}" class="btn btn-success btn-sm" style="padding: 10px 20px; font-size: 14px;">
                        <i class="fas fa-download me-1"></i> Export {{ currency_name }}
                    </a>
                    <button onclick="refreshRecommendations()" class="btn btn-warning btn-sm" style="padding: 10px 20px; font-size: 14px;">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Price Distribution Chart
const priceData = {
    labels: [
        {% for range in price_ranges %}
        '{{ range.range }}',
        {% endfor %}
    ],
    datasets: [{
        label: 'Number of Products',
        data: [
            {% for range in price_ranges %}
            {{ range.count }},
            {% endfor %}
        ],
        backgroundColor: [
            '#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'
        ],
        borderColor: '#fff',
        borderWidth: 3
    }]
};

const priceChart = new Chart(document.getElementById('priceDistributionChart'), {
    type: 'doughnut',
    data: priceData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    font: {
                        size: 12
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed + ' products';
                    }
                }
            }
        },
        cutout: '60%'
    }
});

// Helper Functions
function analyzeCategoryPricing(categoryId) {
    // Get current currency from URL
    const urlParams = new URLSearchParams(window.location.search);
    const currency = urlParams.get('currency') || 'INR';
    
    // Navigate to category-specific analysis with currency parameter
    const analysisUrl = `{% url 'admin_dashboard:category_pricing_analysis' 0 %}`.replace('0', categoryId) + `?currency=${currency}`;
    
    const toast = new bootstrap.Toast(document.createElement('div'));
    toast._element.innerHTML = `
        <div class="toast-header">
            <i class="fas fa-chart-line text-primary me-2"></i>
            <strong class="me-auto">Category Analysis (${currency})</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            Opening detailed ${currency} pricing analysis for this category...
            <div class="mt-2">
                <a href="${analysisUrl}" class="btn btn-sm btn-primary">View Analysis</a>
            </div>
        </div>
    `;
    document.body.appendChild(toast._element);
    toast.show();
}

function exportPricingData() {
    // Show loading state
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Exporting...';
    btn.disabled = true;
    
    // Simulate export (replace with actual export URL)
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        // Show success message
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show';
        alert.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            Pricing data exported successfully!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.admin-content').insertBefore(alert, document.querySelector('.admin-content').firstChild);
    }, 2000);
}

function refreshRecommendations() {
    // Show loading state
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Refreshing...';
    btn.disabled = true;
    
    // Get current currency from URL
    const urlParams = new URLSearchParams(window.location.search);
    const currency = urlParams.get('currency') || 'INR';
    
    // Make API call to refresh recommendations with currency
    fetch(`{% url 'admin_dashboard:pricing_recommendations_api' %}?currency=${currency}`)
        .then(response => response.json())
        .then(data => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                Recommendations refreshed for ${data.currency}! Found ${data.recommendations.length} recommendations.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.admin-content').insertBefore(alert, document.querySelector('.admin-content').firstChild);
            
            // Optionally reload the page to show updated recommendations
            setTimeout(() => location.reload(), 1000);
        })
        .catch(error => {
            btn.innerHTML = originalText;
            btn.disabled = false;
            console.error('Error refreshing recommendations:', error);
            location.reload();
        });
}

// Auto-refresh every 5 minutes
setInterval(function() {
    // Only auto-refresh if user is active
    if (document.visibilityState === 'visible') {
        refreshRecommendations();
    }
}, 300000); // 5 minutes
</script>
{% endblock %}
