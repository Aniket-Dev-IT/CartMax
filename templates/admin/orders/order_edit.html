{% extends "admin/professional_base.html" %}
{% load static %}

{% block title %}Edit Order #{{ order.order_id }}{% endblock %}

{% block page_title %}Edit Order - #{{ order.order_id }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/order-edit-compact.css' %}">
<style>
.admin-content { padding: 8px !important; }
.dashboard-card { 
    margin-bottom: 6px !important; 
    padding: 0 !important; 
    min-height: auto !important;
    height: auto !important;
    border-radius: 6px !important;
}
.dashboard-card .card-header { 
    padding: 6px 8px !important; 
    margin-bottom: 4px !important; 
    font-size: 12px !important;
    font-weight: 600 !important;
    line-height: 1.3 !important;
}
.dashboard-card .card-body { 
    padding: 6px 8px !important;
    min-height: auto !important;
    height: auto !important;
}
.dashboard-card .mb-2, .dashboard-card .mb-3 { margin-bottom: 4px !important; }
.dashboard-card .col-md-4, .dashboard-card .col-md-6 { margin-bottom: 4px !important; }
.dashboard-card label { margin-bottom: 3px !important; font-size: 12px !important; font-weight: 500 !important; display: block !important; }
.dashboard-card input, .dashboard-card select, .dashboard-card textarea { padding: 4px 6px !important; font-size: 12px !important; height: auto !important; min-height: auto !important; }
.dashboard-card .btn { padding: 4px 10px !important; font-size: 12px !important; margin-bottom: 3px !important; min-height: auto !important; height: auto !important; }
.dashboard-card .table { font-size: 12px !important; margin-bottom: 0 !important; }
.dashboard-card .table th, .dashboard-card .table td { padding: 4px 6px !important; }
.dashboard-card small { font-size: 11px !important; margin-top: 2px !important; display: block !important; color: #666 !important; }
.col-lg-3 .dashboard-card { margin-bottom: 6px !important; }
.col-lg-3 .text-center { padding: 4px 6px !important; }
.col-lg-3 h5 { font-size: 12px !important; margin: 0 0 2px 0 !important; font-weight: 600 !important; }
.col-lg-3 hr { margin: 4px 0 !important; }
.col-lg-3 strong { font-size: 11px !important; font-weight: 600 !important; }
.col-lg-3 span { font-size: 11px !important; }
.row { margin: 0 !important; }
.d-grid.gap-1, .d-grid.gap-2 { gap: 3px !important; }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto;">
    <div class="row">
    <div class="col-lg-9">
        <!-- Order Status Update -->
        <div class="dashboard-card mb-2">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-edit text-primary me-2"></i>
                    Update Order Status
                </h3>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <label for="status" class="form-label fw-bold">Order Status *</label>
                            <select name="status" id="status" class="form-select">
                                {% for value, label in status_choices %}
                                    <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label for="tracking_number" class="form-label fw-bold">Tracking Number</label>
                            <input type="text" name="tracking_number" id="tracking_number" class="form-control" 
                                   value="{{ order.tracking_number|default:'' }}" placeholder="Enter tracking number">
                        </div>
                        <div class="col-md-4 mb-2 d-flex align-items-end">
                            <button type="submit" name="action" value="update_status" class="btn btn-professional">
                                <i class="fas fa-save me-2"></i>Update Status
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <label for="status_note" class="form-label fw-bold">Status Update Note (Optional)</label>
                        <textarea name="status_note" id="status_note" class="form-control" rows="2" 
                                  placeholder="Add a note about this status change..."></textarea>
                        <small class="form-text text-muted">This note will be added to the order timeline and may be visible to the customer</small>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Shipping Information -->
        <div class="dashboard-card mb-2">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-shipping-fast text-primary me-2"></i>
                    Shipping Information
                </h3>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="shipping_method" class="form-label fw-bold">Shipping Method</label>
                            <select name="shipping_method" id="shipping_method" class="form-select">
                                <option value="standard" {% if order.shipping_method == 'standard' %}selected{% endif %}>Standard Shipping</option>
                                <option value="express" {% if order.shipping_method == 'express' %}selected{% endif %}>Express Shipping</option>
                                <option value="overnight" {% if order.shipping_method == 'overnight' %}selected{% endif %}>Overnight</option>
                                <option value="pickup" {% if order.shipping_method == 'pickup' %}selected{% endif %}>Store Pickup</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="shipping_cost" class="form-label fw-bold">Shipping Cost</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" name="shipping_cost" id="shipping_cost" class="form-control" 
                                       value="{{ order.shipping_cost|default:0 }}" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <label for="shipping_notes" class="form-label fw-bold">Shipping Notes</label>
                        <textarea name="shipping_notes" id="shipping_notes" class="form-control" rows="2" 
                                  placeholder="Special shipping instructions...">{{ order.shipping_notes|default:'' }}</textarea>
                    </div>
                    
                    <button type="submit" name="action" value="update_shipping" class="btn btn-outline-primary">
                        <i class="fas fa-save me-2"></i>Update Shipping Info
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Order Items Management -->
        <div class="dashboard-card mb-2">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-box text-primary me-2"></i>
                    Order Items
                </h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order_items %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if item.product.main_image %}
                                            <img src="{{ item.product.main_image.url }}" class="me-2" 
                                                 style="width: 30px; height: 30px; object-fit: cover; border-radius: 4px;" 
                                                 alt="{{ item.product.name }}">
                                        {% endif %}
                                        <div>
                                            <small class="fw-bold">{{ item.product.name|truncatechars:30 }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>₹{{ item.price }}</td>
                                <td>
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="item_id" value="{{ item.id }}">
                                        <input type="number" name="quantity" value="{{ item.quantity }}" 
                                               class="form-control form-control-sm" style="width: 80px; display: inline-block;" 
                                               min="1" max="99">
                                        <button type="submit" name="action" value="update_quantity" class="btn btn-sm btn-outline-secondary ms-1">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                </td>
                                <td class="fw-bold">₹{{ item.get_total_price }}</td>
                                <td>
                                    {% if order.status == 'pending' %}
                                    <form method="post" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="item_id" value="{{ item.id }}">
                                        <button type="submit" name="action" value="remove_item" class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('Remove this item from the order?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-light">
                                <td colspan="3" class="text-end fw-bold">Total:</td>
                                <td class="fw-bold">₹{{ order.total }}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Internal Notes -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-sticky-note text-primary me-2"></i>
                    Internal Notes
                </h3>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-2">
                        <label for="internal_notes" class="form-label fw-bold">Admin Notes (Internal Only)</label>
                        <textarea name="internal_notes" id="internal_notes" class="form-control" rows="3" 
                                  placeholder="Add internal notes about this order...">{{ order.internal_notes|default:'' }}</textarea>
                        <small class="form-text text-muted">These notes are only visible to admin staff and not to customers</small>
                    </div>
                    
                    <button type="submit" name="action" value="update_notes" class="btn btn-outline-secondary">
                        <i class="fas fa-save me-2"></i>Save Notes
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3">
        <!-- Order Summary -->
        <div style="position: sticky; top: 80px;">
        <div class="dashboard-card mb-3">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    Order Summary
                </h3>
            </div>
            <div class="card-body">
                <div class="text-center mb-2 p-2 bg-light rounded">
                    <h5 class="mb-1">#{{ order.order_id }}</h5>
                    <span class="badge status-badge order-status-{{ order.status }} px-2 py-1" style="font-size: 0.875rem;">
                        {{ order.get_status_display }}
                    </span>
                </div>
                
                <div class="row mb-2 text-center" style="font-size: 0.95rem;">
                    <div class="col-6">
                        <div class="fw-bold">₹{{ order.total }}</div>
                        <small class="text-muted">Total</small>
                    </div>
                    <div class="col-6">
                        <div class="fw-bold">{{ order_items|length }}</div>
                        <small class="text-muted">Items</small>
                    </div>
                </div>
                
                <hr style="margin: 0.75rem 0;">
                
                <div class="mb-2" style="font-size: 0.95rem;">
                    <strong>Customer:</strong><br>
                    <span style="font-size: 0.9rem;">{{ order.user.get_full_name|default:order.user.username }}</span><br>
                    <small class="text-muted">{{ order.email }}</small>
                </div>
                
                <div class="mb-2" style="font-size: 0.95rem;">
                    <strong>Order Date:</strong><br>
                    <span style="font-size: 0.9rem;">{{ order.created_at|date:"M d, Y H:i" }}</span>
                </div>
                
                {% if order.tracking_number %}
                <div class="mb-2" style="font-size: 0.95rem;">
                    <strong>Tracking:</strong><br>
                    <code style="font-size: 0.85rem;">{{ order.tracking_number }}</code>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="dashboard-card mb-3">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-bolt text-primary me-2"></i>
                    Quick Actions
                </h3>
            </div>
            <div class="card-body d-grid gap-1">
                <a href="{% url 'admin_dashboard:order_detail' order.id %}" class="btn btn-outline-primary">
                    <i class="fas fa-eye me-2"></i>View Details
                </a>
                
                {% if order.status == 'pending' %}
                <form method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" name="action" value="quick_confirm" class="btn btn-success w-100">
                        <i class="fas fa-check me-2"></i>Quick Confirm
                    </button>
                </form>
                {% endif %}
                
                {% if order.status == 'confirmed' %}
                <form method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" name="action" value="quick_ship" class="btn btn-warning w-100">
                        <i class="fas fa-shipping-fast me-2"></i>Quick Ship
                    </button>
                </form>
                {% endif %}
                
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="sendEmail('status_update')">
                        <i class="fas fa-envelope me-1"></i>Email Customer
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="printLabel()">
                        <i class="fas fa-print me-1"></i>Shipping Label
                    </button>
                </div>
                
                <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteOrderModal">
                    <i class="fas fa-trash me-2"></i>Delete Order
                </button>
            </div>
        </div>
        
        <!-- Order History -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-history text-primary me-2"></i>
                    Recent Changes
                </h3>
            </div>
            <div class="card-body">
                <div class="history-timeline">
                    <div class="history-item">
                        <div class="history-time">{{ order.updated_at|timesince }} ago</div>
                        <div class="history-action">Last updated</div>
                    </div>
                    <div class="history-item">
                        <div class="history-time">{{ order.created_at|timesince }} ago</div>
                        <div class="history-action">Order created</div>
                    </div>
                </div>
                
                <div class="mt-2">
                    <a href="{% url 'admin_dashboard:order_list' %}" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-arrow-left me-2"></i>Back to Orders
                    </a>
                </div>
            </div>
        </div>
        </div>
    </div>
    </div>
</div>

<!-- Status Change Confirmation Modal -->
<div class="modal fade" id="statusChangeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Status Change</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to change the order status?</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> Changing the status will automatically send a notification email to the customer.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmStatusChange()">
                    <i class="fas fa-check me-2"></i>Confirm Change
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Order Confirmation Modal -->
<div class="modal fade" id="deleteOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Delete Order - Permanent Action
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone. The order will be permanently deleted from the system.
                </div>
                
                <p class="mb-3"><strong>Order to be deleted:</strong> <code>#{{ order.order_id }}</code></p>
                
                <p class="text-muted mb-3">This will remove the order and all associated data. Customers with this order may not have a record of their purchase.</p>
                
                <form id="deleteOrderForm" method="post" action="{% url 'admin_dashboard:order_delete' order.id %}">
                    {% csrf_token %}
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="confirmDeleteCheckbox" name="confirm_delete" required>
                        <label class="form-check-label" for="confirmDeleteCheckbox">
                            I understand this action cannot be undone and will permanently delete this order.
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteOrder()" id="confirmDeleteBtn" disabled>
                    <i class="fas fa-trash me-2"></i>Confirm Delete
                </button>
            </div>
        </div>
    </div>
</div>


{% block extra_js %}
<script>
// Form change detection
let formChanged = false;
const forms = document.querySelectorAll('form');

forms.forEach(form => {
    const inputs = form.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            formChanged = true;
        });
    });
});

// Warn about unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (formChanged) {
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
    }
});

// Status change with confirmation
function confirmStatusChange() {
    const statusForm = document.querySelector('form');
    statusForm.submit();
    document.getElementById('statusChangeModal').modal('hide');
}

// Email functions
function sendEmail(type) {
    let subject = '';
    let template = '';
    
    switch(type) {
        case 'status_update':
            subject = 'Order Status Update';
            template = 'status_update';
            break;
        default:
            subject = 'Order Update';
            template = 'general';
    }
    
    // Open email composition modal or send directly
    fetch('/admin-dashboard/orders/{{ order.id }}/send-email/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            'type': type,
            'subject': subject,
            'template': template
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Email sent successfully!', 'success');
        } else {
            showAlert('Failed to send email: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error sending email', 'danger');
        console.error('Error:', error);
    });
}

function printLabel() {
    window.open('/admin-dashboard/orders/{{ order.id }}/shipping-label/', '_blank');
}

function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.admin-content');
    container.insertBefore(alert, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// Auto-save notes
let notesSaveTimeout;
const notesTextarea = document.getElementById('internal_notes');
if (notesTextarea) {
    notesTextarea.addEventListener('input', function() {
        clearTimeout(notesSaveTimeout);
        notesSaveTimeout = setTimeout(autoSaveNotes, 3000);
    });
}

function autoSaveNotes() {
    const notes = document.getElementById('internal_notes').value;
    
    fetch('/admin-dashboard/orders/{{ order.id }}/auto-save-notes/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({'notes': notes})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Notes auto-saved');
        }
    })
    .catch(error => {
        console.error('Auto-save error:', error);
    });
}

// Delete order confirmation
const confirmDeleteCheckbox = document.getElementById('confirmDeleteCheckbox');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

if (confirmDeleteCheckbox) {
    confirmDeleteCheckbox.addEventListener('change', function() {
        confirmDeleteBtn.disabled = !this.checked;
    });
}

function confirmDeleteOrder() {
    const deleteForm = document.getElementById('deleteOrderForm');
    if (deleteForm) {
        deleteForm.submit();
    }
}
</script>
{% endblock %}
{% endblock %}
